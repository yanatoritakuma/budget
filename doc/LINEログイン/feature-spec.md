# LINEログイン機能 機能仕様書

## 1. 概要

本ドキュメントは、既存のアプリケーションにLINEアカウントを利用したログイン機能を追加するための機能仕様を定義する。
ユーザーはLINEアカウント情報を提供することで、新規登録およびログインが可能になる。

## 2. 認証フロー

本機能はLINEのOAuth 2.0およびOpenID Connectプロトコルに準拠して実装する。各コンポーネントの役割とデータの流れは以下の通り。

1.  **ログイン要求 (ユーザー → フロントエンド)**
    *   ユーザーがフロントエンドの「LINEでログイン」ボタンをクリックする。

2.  **認可URLの取得 (フロントエンド → バックエンド)**
    *   フロントエンドは、バックエンドが提供する `GET /api/v1/auth/line/login` エンドポイントにリクエストを送信する。
    *   バックエンド（usecase層）は、このリクエストを受けてCSRF対策のための `state` を生成・保存する。
    *   バックエンドは、LINEのチャネル情報や `state` を含んだ **「LINE認可エンドポイントのURL」を組み立て**、JSON形式でフロントエンドに返却する。この時点ではLINEのAPIは呼び出さない。

3.  **LINE認可画面への遷移 (フロントエンド)**
    *   フロントエンドは、バックエンドから受け取った「LINE認可エンドポイントのURL」へユーザーをリダイレクトさせる。

4.  **ユーザー認証とコールバック (ユーザー → LINEプラットフォーム → フロントエンド)**
    *   ユーザーはLINEのサイト上でIDとパスワードを入力し、認証・認可を行う。
    *   認証が成功すると、**LINEプラットフォーム**は、事前に設定されたフロントエンドのコールバックパス (`/auth/callback`) へユーザーのブラウザをリダイレクトさせる。
    *   この時、リダイレクト先のURLのクエリパラメータとして、**認可コード (`code`)** と、ステップ2で生成された `state` が付与される。

5.  **サーバーサイドでの認証処理 (フロントエンド → バックエンド)**
    *   フロントエンドのコールバックページ (`/auth/callback`) は、URLから `code` と `state` を取得する。
    *   フロントエンドは、取得した `code` と `state` を添えて、バックエンドが提供する `GET /api/v1/auth/line/callback` エンドポイントをコールする。
    *   バックエンドは、まず `state` を検証してリクエストの正当性を確認する。
    *   次に、受け取った `code` を使って、バックエンドから **LINEプラットフォームのトークン発行APIを初めてコール**する。
    *   LINEプラットフォームから**アクセストークン**と**IDトークン**を受け取る。IDトークンには検証済みのユーザー情報（LINEユーザーIDなど）が含まれている。

6.  **ユーザー登録・ログインとJWT発行 (バックエンド)**
    *   バックエンドは、IDトークンから取得したLINEユーザーIDをキーにDBの `users` テーブルを検索する。
        *   ユーザーが存在しない場合：新しいユーザーとして情報をDBに登録する。
        *   ユーザーが存在する場合：既存ユーザーとして処理を続行する。
    *   アプリケーション独自のJWT（セッショントークン）を生成し、HTTPレスポンスに含めてフロントエンドに返却する。

7.  **ログイン完了 (フロントエンド)**
    *   フロントエンドは、バックエンドから受け取ったJWTをCookieなどに安全に保存し、ログイン状態を確立する。
    *   ユーザーをログイン後のトップページへリダイレクトする。


## 3. 機能一覧

機能追加・変更は以下の3つのレイヤーに分類される。

### 3.1. フロントエンド (Next.js)

| 機能分類 | 項目 | 概要 |
| :--- | :--- | :--- |
| **画面** | ログインページ (`/auth`) | - 「LINEでログイン」ボタンを設置する。 |
| | コールバックページ (`/auth/callback`) | - **【新規作成】**<br>- LINEからのリダイレクトを受け付ける。<br>- URLから `code` と `state` を抽出し、バックエンドへ送信する。<br>- バックエンドから受け取ったJWTを保存し、トップページへ遷移する。 |
| **API通信** | LINEログインAPI | - `GET /api/v1/auth/line/login` を呼び出し、LINE認可URLを取得する。 |
| | コールバックAPI | - `GET /api/v1/auth/line/callback` を呼び出し、`code` と `state` を送信してJWTを取得する。 |
| **状態管理** | 認証状態 | - JWTの有無に基づき、ユーザーのログイン状態を管理する。 |

### 3.2. バックエンド (Go)

| 機能分類 | 項目 | 概要 |
| :--- | :--- | :--- |
| **API** | `GET /api/v1/auth/line/login` | - **【新規作成】**<br>- LINE認可エンドポイントへのリダイレクトURLを生成し、JSON形式で返却する。 |
| | `GET /api/v1/auth/line/callback` | - **【新規作成】**<br>- `code` と `state` を受け取り、LINEプラットフォームと通信してユーザー認証を行う。<br>- 認証成功後、JWTを発行して返却する。 |
| **ビジネスロジック** | ユーザー認証 | - **【新規作成】**<br>- LINEログイン用のユースケースを実装する。<br>- LINEユーザーIDでユーザーを検索し、存在しない場合は新規登録する。 |
| **データアクセス** | `UserRepository` | - **【変更】**<br>- `FindByLineUserID(lineUserID string)` メソッドを追加する。 |
| **ドメイン** | `User` モデル | - **【変更】**<br>- `LineUserID` (string) フィールドを追加する。 |
| **設定** | 環境変数 | - **【追加】**<br>- `LINE_CHANNEL_ID`<br>- `LINE_CHANNEL_SECRET`<br>- `LINE_REDIRECT_URI` |

### 3.3. データベース (DB)

| 機能分類 | 項目 | 概要 |
| :--- | :--- | :--- |
| **テーブルスキーマ** | `users` テーブル | - **【変更】**<br>- `line_user_id` カラムを追加する。<br>  - 型: `VARCHAR`<br>  - 制約: `UNIQUE` |

